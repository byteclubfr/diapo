<!DOCTYPE html>
<meta charset="utf-8">

<title>Diapo</title>

<diapo>
  <h1>First diapo</h1>
  <p>A small text content on 1 line.</p>
</diapo>

<diapo>
  <h1>Second diapo</h1>
  <p>A list of things:</p>
  <ul>
    <li>first thing</li>
    <li>second thing</li>
  </ul>
</diapo>

<diapo class="center-x center-y">
  <h1>Third diapo centered title</h1>
</diapo>

<diapo>
  <h1>Fourth with table</h1>
  <table>
    <tr>
      <th></th>
      <th>Col 1</th>
      <th>Col 2</th>
      <th>Col 3</th>
    </tr>
    <tr>
      <th>Row 1</th>
      <td></td>
      <td>×</td>
      <td></td>
    </tr>
    <tr>
      <th>Row 2</th>
      <td></td>
      <td></td>
      <td>×</td>
    </tr>
  </table>
</diapo>

<diapo>
  <h1>Fifth diapo with code</h1>
  <pre><code>
    function add (a, b) {
      return a + b
    }

    const sum = [4, 2, 1].reduce(add, 0)
  </code></pre>
</diapo>

<template>
  <h1>New diapo title</h1>
  <p>A dummy paragraph</p>
</template>


<!-- diapo engine: here be dragons -->

<style>
* {
  box-sizing: border-box;
}
html, body {
  margin: 0;
  padding: 0;
  overflow: hidden;
}
html {
  background: #fff;
}
body {
  background: #eee;
  width: 800px; height: 600px;
  margin-left: -400px; margin-top: -300px;
  position: absolute; top: 50%; left: 50%;
  font-family: Arial, Helvetica, sans-serif;
  display: none;
}
body.loaded {
  display: block;
}
diapo {
  background: #ddd;
  width: 100%; height: 100%;
  display: block;
  position: absolute;
  padding: 10px;
  transition: left 300ms ease-in 0s;
}
diapo { left: -100% } /* Before */
diapo[aria-selected] { left: 0 } /* Now */
diapo[aria-selected] ~ diapo { left: +100% } /* After */
diapo[contenteditable] { background: #ccc; }

diapo.center-x {
  display: flex;
  justify-content: center;
}
diapo.center-y {
  display: flex;
  align-items: center;
}

nav {
  background: #ccc;
  bottom: 0; width: 100%;
  display: flex;
  position: absolute;
}
nav button {
  flex: 1;
}
nav .counter {
  align-self: center;
  padding: 1em;
  white-space: nowrap;
}

</style>

<script>
(function () {

const state = {
  index: 0,
  total: 0
}

// CRUD

// current
const getDiapo = () => $('diapo[aria-selected]')

const injectDiapo = (position) => {
  const diapo = E('diapo', { innerHTML: state.dummyHTML })
  const current = getDiapo()
  if (position === 'before') {
    document.body.insertBefore(diapo, current)
    state.index++
  } else {
    document.body.insertBefore(diapo, current.nextSibling)
  }
  state.total++
  setHash(position === 'before' ? state.index - 1 : state.index + 1)
}

const deleteDiapo = () => {
  getDiapo().remove()
  if (state.index === state.total) state.index--
  state.total--
  goTo(state.index)
}

const moveDiapo = (position) => {
  const diapos = $$('diapo')
  const current = diapos[state.index - 1]
  if (position === 'before') {
    current.parentNode.insertBefore(current, diapos[state.index - 2])
    setHash(state.index - 1)
  } else {
    current.parentNode.insertBefore(diapos[state.index], current)
    setHash(state.index + 1)
  }
}

// ui

const createButtons = (state) => {
  const start = E('button', {
    textContent: '|◀◀',
    onclick: () => goStart(),
    disabled: state.index === 1
  })
  const back = E('button', {
    textContent: '◀',
    onclick: () => goBack(),
    disabled: state.index === 1
  })
  const moveBefore = E('button', {
    textContent: 'Move diapo before',
    onclick: () => moveDiapo('before'),
    disabled: state.index === 1
  })
  const addBefore = E('button', {
    textContent: 'Create new diapo before',
    onclick: () => injectDiapo('before')
  })
  const remove = E('button', {
    textContent: 'Delete diapo',
    onclick: () => {
      if (confirm('Are you sure you want to delete this diapo?')) deleteDiapo()
    }
  })
  const counter = E('div', {
    className: 'counter',
    textContent: `${state.index} / ${state.total}`
  })
  const edit = E('button', {
    textContent: 'Edit diapo',
    onclick: () => {
      getDiapo().setAttribute('contenteditable', 'true')
    }
  })
  const addAfter = E('button', {
    textContent: 'Create new diapo after',
    onclick: () => injectDiapo('after')
  })
  const moveAfter = E('button', {
    textContent: 'Move diapo after',
    onclick: () => moveDiapo('after'),
    disabled: state.index === state.total
  })
  const forward = E('button', {
    textContent: '▶',
    onclick: () => goForward(),
    disabled: state.index === state.total
  })
  const end = E('button', {
    textContent: '▶▶|',
    onclick: () => goEnd(),
    disabled: state.index === state.total
  })
  return [start, back, moveBefore, addBefore,
    remove, counter, edit,
    addAfter, moveAfter, forward, end]
}

const refreshUI = (state) => {
  let ui = $('nav.ui')
  if (ui) ui.remove()

  ui = E('nav', { className: 'ui' })

  createButtons(state).forEach(b => ui.appendChild(b))
  return document.body.append(ui)
}

// navigation

const goTo = (index) => {
  state.index = index
  const current = getDiapo()
  const next = $(`diapo:nth-of-type(${ index })`)
  if (current) {
    current.removeAttribute('aria-selected')
    current.removeAttribute('contenteditable')
  }
  if (next) next.setAttribute('aria-selected', 'true')
  refreshUI(state)
}

const goBack = () => {
  if (state.index > 1) setHash(state.index - 1)
}

const goForward = () => {
  if (state.index !== state.total) setHash(state.index + 1)
}

const goStart = () => {
  setHash(1)
}

const goEnd = () => {
  setHash(state.total)
}

const onKeyDown = (e) => {
  const { keyCode } = e
  // don't intercept keyboard chords
  if (e.altKey || e.ctrlKey || e.metaKey || e.shiftKey) return

  // left, up, page up
  if ([37, 38, 33].includes(keyCode)) {
    e.preventDefault()
    goBack()
  }
  // right, down, page down
  if ([39, 40, 34].includes(keyCode)) {
    e.preventDefault()
    goForward()
  }
}

const onHashChange = () => {
  const index = Number(window.location.hash.split('#')[1]) || 1
  if (index !== state.index) goTo(index)
}

const setHash = (index) => {
  window.location.hash = `#${index}`
}

// edit mode

const onDoubleClick = (e) => {
  e.preventDefault()
  if (e.target.tagName !== 'DIAPO') return
  e.target.setAttribute('contenteditable', 'true')
}

// scale

const onResize = () => {
  const b = document.body
  const w = b.clientWidth / window.innerWidth
  const h = b.clientHeight / window.innerHeight
  b.style.transform = `scale(${ 1 / Math.max(w, h) })`
}

// let's roll

const init = () => {
  onHashChange()
  document.body.className = 'loaded'
  state.total = $$('diapo').length
  state.dummyHTML = $('template').innerHTML

  onResize()
  refreshUI(state)

  window.onkeydown = onKeyDown
  window.ondblclick = onDoubleClick
  window.onresize = onResize
  window.onhashchange = onHashChange
}

window.onload = init

})()
</script>

<script>
// global helpers

function E (tag, props) {
  var elt = document.createElement(tag)
  if (props) {
    for (var p in props) {
      elt[p] = props[p]
    }
  }
  return elt
}

var $ = (HTMLElement.prototype.$ = function(q) {
  return this.querySelector(q);
}).bind(document)

var $$ = (HTMLElement.prototype.$$ = function(q) {
  return this.querySelectorAll(q);
}).bind(document)
</script>
